@using System.Security.Claims
@using barberchainAPI.Data
@inject BarberchainDbContext Context
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mx-auto mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4">Schedule Adjustment Requests</MudText>

        @if (requests == null)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else if (!requests.Any())
        {
            <MudText>No requests found.</MudText>
        }
        else
        {
            <MudTable Items="requests" Hover="true" Bordered="true" Striped="true">
                <HeaderContent>
                    <MudTh>Barber</MudTh>
                    <MudTh>Date</MudTh>
                    <MudTh>Reason</MudTh>
                    <MudTh>Requested Changes</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>

                <RowTemplate Context="r">
                    <MudTd>@r.Barber.Account.Lastname @r.Barber.Account.Restname</MudTd>
                    <MudTd>@r.RequestDate.ToString("yyyy-MM-dd")</MudTd>
                    <MudTd>@r.Message</MudTd>
                    <MudTd>
                        <div class="timeline-wrapper">
                            @for (int i = 0; i < r.AtuPattern.Length; i++)
                            {
                                <div class="time-block @(r.AtuPattern[i] ? "available" : "unavailable")"
                                     style="width:15px;height:15px;margin:1px;display:inline-block;"></div>
                            }
                        </div>
                    </MudTd>
                    <MudTd>@r.Status</MudTd>
                    <MudTd>
                        @if (r.Status == ScheduleRequestStatus.Pending)
                        {
                            <MudButton Color="Color.Success" Size="Size.Small" OnClick="() => ApproveRequest(r.Id)">Approve</MudButton>
                            <MudButton Color="Color.Error" Size="Size.Small" OnClick="() => DeclineRequest(r.Id)">Decline</MudButton>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ScheduleRequest> requests;

    [Parameter] public ClaimsPrincipal? User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadRequests();
    }

    private async Task LoadRequests()
    {
        var managerId = int.Parse(User.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);

        requests = await Context.ScheduleRequests
            .Include(r => r.Barber)
                .ThenInclude(b => b.Account)
            .Include(r => r.Barber)
                .ThenInclude(b => b.Bshop)
            .Where(r => r.Barber.Bshop.ManagerAccountId == managerId)
            .OrderByDescending(r => r.RequestDate)
            .ToListAsync();
    }

    private async Task ApproveRequest(int requestId)
    {
        var req = await Context.ScheduleRequests.FindAsync(requestId);
        if (req != null)
        {
            req.Status = ScheduleRequestStatus.Approved;
            await Context.SaveChangesAsync();
            await LoadRequests();
        }
    }

    private async Task DeclineRequest(int requestId)
    {
        var req = await Context.ScheduleRequests.FindAsync(requestId);
        if (req != null)
        {
            req.Status = ScheduleRequestStatus.Rejected;
            await Context.SaveChangesAsync();
            await LoadRequests();
        }
    }
}
