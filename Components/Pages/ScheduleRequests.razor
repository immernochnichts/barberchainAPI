@namespace barberchainAPI.Components.Pages
@using System.Security.Claims
@using System.Collections
@using System.Text
@using barberchainAPI.Data
@using barberchainAPI.Functional.Services
@inject BarberchainDbContext Context
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IScheduleRequestService ScReqService

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<style>
    .timeline-wrapper {
        overflow-x: auto;
        width: 100%;
    }

    .hour-markers,
    .availability-line {
        display: flex;
    }

    .hour-marker {
        flex: 0 0 auto; /* prevent shrinking */
        width: 100px; /* 4 slots per hour */
        text-align: left;
        font-size: 12px;
    }

    .time-block {
        flex: 0 0 auto; /* prevent shrinking */
        width: 25px;
        height: 25px;
        border-radius: 5px;
        border: 1px solid darkgrey;
    }

        .time-block.available {
            background-color: white;
        }

        .time-block.unavailable {
            background-color: darkgray;
        }

    .hover-layer {
        position: absolute;
        top: 15px;
        left: 25px;
        height: 30px;
        pointer-events: none;
        display: flex;
    }

    .time-block,
    .hover-cell {
        box-sizing: border-box;
    }
</style>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">Заявки на изменение расписания</MudText>

    @if (requests == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (!requests.Any())
    {
        <MudText>Заявок нет</MudText>
    }
    else
    {
        <MudTable Items="requests" Hover="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh>Barber</MudTh>
                <MudTh>Date</MudTh>
                <MudTh>Reason</MudTh>
                <MudTh>Requested Changes</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate Context="r">
                <MudTd>@r.Barber.Account.Lastname @r.Barber.Account.Restname</MudTd>
                <MudTd>@r.RequestDate.ToString("yyyy-MM-dd")</MudTd>
                <MudTd>@r.Message</MudTd>
                <MudTd>
                    @ScReqService.GetScheduleChangesAsync(r.Id)
                </MudTd>
                <MudTd>@r.Status</MudTd>
                <MudTd>
                    @if (r.Status == ScheduleRequestStatus.Pending)
                    {
                        <MudButton Color="Color.Success" Size="Size.Small" OnClick="() => ApproveRequest(r.Id)">Approve</MudButton>
                        <MudButton Color="Color.Error" Size="Size.Small" OnClick="() => DeclineRequest(r.Id)">Decline</MudButton>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    private List<ScheduleRequest> requests = default!;

    [Parameter] public ClaimsPrincipal? User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var managerId = int.Parse(User!.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);

        requests = await ScReqService.LoadRequestsAsync(managerId);
    }

    private async Task ApproveRequest(int requestId)
    {
        var req = await Context.ScheduleRequests.FindAsync(requestId);
        var declinedOrderCount = !string.IsNullOrEmpty(req!.OrderIdsToDecline) ? req.OrderIdsToDecline?.Split(" ").Count() : 0;

        bool? confirmed = await DialogService.ShowMessageBox(
            "Подтвердите изменение расписания",
            $"Изменить расписание? {declinedOrderCount} заказов будет отменено ",
            yesText: "Подтвердить", cancelText: "Отмена");

        if (confirmed != null && confirmed.Value)
        {
            await ScReqService.ApproveRequestAsync(req);
        }
    }

    private async Task DeclineRequest(int requestId)
    {
        var req = await Context.ScheduleRequests.FindAsync(requestId);
        if (req != null)
        {
            var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large, FullWidth = true };
            var params_ = new DialogParameters<DeclineRequestDialog> {
            { x => x.Request, req } };

            var dialog = await DialogService.ShowAsync<DeclineRequestDialog>("Отклонить изменение расписания", params_, options);

            var dialogResult = await dialog.Result;

            if (dialogResult != null && !dialogResult.Canceled)
            {
                var updatedReq = dialogResult.Data as ScheduleRequest;

                await ScReqService.NotifyBarberAsync(updatedReq!);
                var managerId = int.Parse(User!.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);
                requests = await ScReqService.LoadRequestsAsync(managerId);
                StateHasChanged();
            }
        }
    }
}
