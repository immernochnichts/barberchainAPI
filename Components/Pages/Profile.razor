@namespace barberchainAPI.Components.Pages
@using MudBlazor
@using System.Collections
@using System.Security.Claims
@using barberchainAPI.Functional;
@inject IDialogService DialogService
@inject BarberchainDbContext Context
@inject CartService CartService
@inject ISnackbar Snackbar
<MudPopoverProvider />
<MudDialogProvider />

@if (account is null)
{
    <MudText>
        Loading...
    </MudText>
}
else
{
    <MudPaper Elevation="3" Class="p-4 rounded-lg">

        <MudContainer Style="display:flex; padding-top:1rem;">
            <MudImage Src="@AccountPage.GetImageSrc(account.ProfilePic)" Class="rounded-lg" Elevation="25" ObjectFit="ObjectFit.Cover" Style="max-width:50%;" />
            <MudContainer Style="display:flex; flex-direction:column; align-items:flex-start;">
                <MudText Typo="Typo.h5" Align="Align.Center">@account.Lastname @account.Restname</MudText>
                <MudText Typo="Typo.h6" Align="Align.Center">обо мне:</MudText>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="text-secondary">
                    @account.Bio
                </MudText>
                @if (account.Role == AccountRole.Barber)
                {
                    <MudText Typo="Typo.h6" Align="Align.Center">что я умею:</MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Class="text-secondary">
                        @if (jobs is not null && cart != null)
                        {
                            <MudList T="string">
                                @foreach (var job in jobs)
                                {
                                    <MudContainer Class="d-flex" Style="align-items:center">
                                        <MudListItem Text=@job.Job.Name SecondaryText=@(job.Price is null ? job.Job.DefaultPrice.ToString() : job.Price.ToString()) />
                                        <MudButton @onclick="async () => { await OnServiceClicked(job.Job); }" Disabled="false" Style=@($"background:{(cart.JobSet.Contains(job.Job) ? "gray" : job.Job.ColorCSS)}; height:min-content;")>@(cart.JobSet.Contains(job.Job) ? "Добавлено" : "")</MudButton>
                                    </MudContainer>
                                }
                            </MudList>                        
                        }
                    </MudText>
                }
            </MudContainer>
        </MudContainer>

        @if (account.Role == AccountRole.Barber)
        {
            <MudDivider Class="my-4" />

            <!-- Auxiliary Pictures Grid -->
            <MudText Typo="Typo.h6" Class="mb-2">Gallery</MudText>
            @if (barber?.Images != null && barber.Images.Any())
            {
                @foreach (var img in barber.Images)
                {
                    <MudGrid GutterSize="2">
                        <MudItem xs="6" sm="4" md="3">
                            <MudPaper Elevation="1" Class="p-1 rounded">
                                <MudImage Src="@AccountPage.GetImageSrc(img.ImgFile)" Alt="Auxiliary image" Style="width:100%;height:auto;" />
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                }
            }
            else
            {
                <MudText Align="Align.Left">No images available</MudText>
            }

            <MudDivider Class="my-4" />

            <!-- Calendar Section -->
            <MudText Typo="Typo.h6" Class="mb-2">Schedule</MudText>
            <MudDatePicker PickerVariant="PickerVariant.Static" Orientation="Orientation.Landscape" @bind-Date="_selectedDate" />

            <MudDivider Class="my-4" />

            <MudButton @onclick="OpenDialogAsync" Variant="Variant.Filled" Color="Color.Primary">
                Book
            </MudButton>

            <MudDivider Class="my-4" />

            <MudPaper Elevation="3" Class="p-6 rounded-lg">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h4">Отзывы</MudText>
                    <MudExpansionPanel Text="Оставить отзыв" @ref="reviewPanel">
                        <MudPaper Class="pa-4">
                            <MudForm @ref="_form" @bind-IsValid="isFormValid">
                                <MudRating SelectedValue="@((int)reviewModel.Score)" MaxValue="5" Size="Size.Large" Required="true" />

                                <MudSelect T="int" Label="Выберите заказ" @bind-Value="reviewModel.OrderId" Required="true">
                                    @foreach (var o in userOrders)
                                    {
                                        <MudSelectItem T="int" Value="@o.Id">@($"Order #{o.Id} - {o.AppointedTime:dd.MM.yyyy}")</MudSelectItem>
                                    }
                                </MudSelect>

                                <MudTextField T="string" Label="Ваш отзыв" @bind-Value="reviewModel.Text"
                                              Lines="4" />

                                <MudStack AlignItems="AlignItems.End" Row="true">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CancelReview">
                                        Отмена
                                    </MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SubmitReview">
                                        Отправить
                                    </MudButton>
                                </MudStack>
                            </MudForm>
                        </MudPaper>
                    </MudExpansionPanel>
                    <MudDivider Class="mb-2" />

                    <ReviewsForBarber user="@user" barber="@barber"></ReviewsForBarber>
                </MudStack>
            </MudPaper>
        }
    </MudPaper>
}

@code{
    [Parameter]
    public int id { get; set; }

    [Parameter]
    public Account? account { get; set; }

    [Parameter]
    public ClaimsPrincipal? user { get; set; }

    private Cart? cart;

    private bool _loaded = false;

    //Barber variables
    [Parameter]
    public List<BarberJob> jobs { get; set; }

    [Parameter]
    public Barber? barber { get; set; }

    public BitArray? AtuPattern { get; set; }

    protected DateTime? _selectedDate = DateTime.Today;

    public async Task<BitArray> GetAvailabilityForDay(int barberId, DateTime? day)
    {
        var availability = await Context.BarberScheduleDays
            .Where(a => a.BarberId == barberId && a.Date == DateOnly.FromDateTime(day.Value))
            .Select(a => a.AtuPattern)
            .FirstOrDefaultAsync();

        if (availability is null)
        {
            availability = new BitArray(Enumerable.Repeat<bool>(false, 96).ToArray());
        }

        return availability;
    }

    protected override async Task OnAfterRenderAsync(bool firstTime)
    {
        if (firstTime)
        {
            cart = await CartService.GetCart();
            StateHasChanged();
        }
    }

    protected async Task OpenDialogAsync()
    {
        AtuPattern = await GetAvailabilityForDay(barber.Id, _selectedDate);
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true };
        var params_ = new DialogParameters<BarberPageDialog> {
            { x => x.AtuPattern, AtuPattern }, 
            { y => y.SelectedDate, _selectedDate}, 
            { z => z.Barber, barber },
            { w => w.user, user } };

        await DialogService.ShowAsync<BarberPageDialog>("Book time", params_, options);
    }

    private async Task OnServiceClicked(Job j)
    {
        if (cart.JobSet.Contains(j))
        {
            await CartService.RemoveItem(j.Id);
        }
        else
        {
            await CartService.AddToCart(j);
        }

        cart = await CartService.GetCart(); // update the cart

        StateHasChanged();
    }

    private MudForm _form;
    private MudExpansionPanel reviewPanel;
    private bool isFormValid;

    private ReviewModel reviewModel = new ReviewModel();

    // List of orders eligible for review (e.g., past orders for this barber by current user)
    private List<Order> userOrders = new List<Order>();

    protected override async Task OnInitializedAsync()
    {
        if (user is null)
        {
            userOrders = null;
            return;
        }

        var userId = int.Parse(user.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);

        userOrders = await Context.Orders
            .Where(o => o.AccountId == userId && o.BarberId == barber.Id && o.Status == OrderStatus.Complete)
            .ToListAsync();
    }

    private async Task SubmitReview()
    {
        await _form.Validate();
        if (!isFormValid)
            return;

        var review = new Review
            {
                Score = reviewModel.Score,
                Text = reviewModel.Text,
                OrderId = reviewModel.OrderId,
                AccountId = userOrders.FirstOrDefault(o => o.Id == reviewModel.OrderId)?.AccountId ?? 0,
                BarberId = barber.Id,
                CreatedAt = DateTime.Now
            };

        barber.ReviewSum += reviewModel.Score;
        barber.ReviewCount += 1;

        var currentAccountReview = await Context.Reviews
            .Where(r => r.BarberId == barber.Id && r.AccountId == int.Parse(user.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value))
            .FirstOrDefaultAsync();
        
        if (currentAccountReview == null)
        {
            Context.Reviews.Add(review);
            await Context.SaveChangesAsync();

            reviewModel = new ReviewModel();
            await _form.ResetAsync();
            Snackbar.Add("Review submitted successfully!", Severity.Success);
        }
    }

    private async Task CancelReview()
    {
        await _form?.ResetAsync(); // optional: reset form fields
        reviewPanel?.CollapseAsync();
    }

    public class ReviewModel
    {
        public short Score { get; set; }
        public int OrderId { get; set; }
        public string Text { get; set; }
    }
}