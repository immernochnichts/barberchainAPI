@namespace barberchainAPI.Components.Pages
@inject BarberchainDbContext Context
@using MudBlazor

@if (OrderList?.Count > 0)
{
    <MudPaper Class="p-6">
        <MudStack Spacing="3">
            <MudText Class="mt-4 ml-4" Typo="Typo.h4">История заказов</MudText>
            <MudDivider Class="mb-2" />

            <MudStack Row="true" Spacing="2" Class="mx-4">
                <!-- Status Filter -->
                <MudSelect T="OrderStatus?" Label="Статус заказа" @bind-Value="_selectedStatus" Clearable="true">
                    <!-- "All" option -->
                    <MudSelectItem T="OrderStatus?" Value="@(null)">Все</MudSelectItem>

                    <!-- Specific statuses -->
                    @foreach (OrderStatus status in Enum.GetValues(typeof(OrderStatus)))
                    {
                        <MudSelectItem T="OrderStatus?" Value="@(status)">
                            @GetStatusRus(status)
                        </MudSelectItem>
                    }
                </MudSelect>

                <!-- Sort selection -->
                <MudSelect T="OrderSort" Label="Сортировать по" @bind-Value="_selectedSort">
                    <MudSelectItem Value="OrderSort.AppointedAsc">Назначенное время ↑</MudSelectItem>
                    <MudSelectItem Value="OrderSort.AppointedDesc">Назначенное время ↓</MudSelectItem>
                    <MudSelectItem Value="OrderSort.CreatedAsc">Дата создания ↑</MudSelectItem>
                    <MudSelectItem Value="OrderSort.CreatedDesc">Дата создания ↓</MudSelectItem>
                </MudSelect>
            </MudStack>

            <MudDivider Class="my-2" />

            @foreach (var o in FilteredOrders)
            {
                <a href=@($"/payment/{o.Id}")>
                    <MudCard style="border: 1px solid black;" Elevation="2" Class="mx-4 mb-4">
                        <MudCardContent>
                            <MudStack Spacing="2">

                                <!-- Header -->
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.h6">Заказ №@o.Id</MudText>
                                    <MudChip T="bool" Color="@GetStatusColor(o.Status)"
                                             Label="true"
                                             Variant="Variant.Filled">
                                        @GetStatusRus(o.Status)
                                    </MudChip>
                                </MudStack>

                                <MudDivider />

                                <!-- Appointed time -->
                                <MudStack Row="true" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.EventAvailable" Color="Color.Primary" />
                                    <MudText>
                                        Назначенное время: @o.AppointedTime.ToString("dd MMMM yyyy, HH:mm")
                                    </MudText>
                                </MudStack>

                                <!-- Order time -->
                                <MudStack Row="true" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Color="Color.Primary" />
                                    <MudText>
                                        Создан: @o.OrderTime.ToString("dd MMMM yyyy, HH:mm")
                                    </MudText>
                                </MudStack>

                                <!-- Method -->
                                <MudStack Row="true" Spacing="1">
                                    <MudIcon Icon="@(o.Method == OrderMethod.Online
                                    ? Icons.Material.Filled.Computer
                                    : Icons.Material.Filled.Phone )"
                                             Color="Color.Primary" />
                                    <MudText>
                                        Способ записи: @(o.Method == OrderMethod.Online ? "Онлайн" : "По телефону")
                                    </MudText>
                                </MudStack>

                                <MudDivider Class="my-1" />

                                <!-- Jobs -->
                                <MudText Typo="Typo.subtitle2" Class="mt-1">Услуги:</MudText>
                                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                                    @foreach (var job in o.OrderJobs.Select(j => j.Job).Where(j => j != null))
                                    {
                                        <MudChip T="bool" Label="true" Color="Color.Default" Variant="Variant.Outlined" Class="mb-1">
                                            @job.Name
                                        </MudChip>
                                    }
                                </MudStack>

                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </a>
            }
        </MudStack>
    </MudPaper>
}
else
{
    <MudPaper Class="py-4 p-4 rounded" Style="text-align:center;">
        <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Color="Color.Secondary" Size="Size.Large" />
        <MudText Typo="Typo.h6" Class="mt-2">У вас нет заказов</MudText>
        <MudText Typo="Typo.body2">История заказов будет отображаться здесь</MudText>
    </MudPaper>
}

@code {
    public enum OrderSort
    {
        AppointedAsc,
        AppointedDesc,
        CreatedAsc,
        CreatedDesc
    }

    [Parameter] public int id { get; set; }

    private List<Order> OrderList { get; set; } = new();
    private OrderStatus? _selectedStatus = null;
    private OrderSort _selectedSort = OrderSort.AppointedAsc;

    protected override async Task OnInitializedAsync()
    {
        OrderList = await Context.Orders
            .Include(o => o.OrderJobs)
                .ThenInclude(oj => oj.Job)
            .Where(o => o.AccountId == id)
            .OrderBy(o => o.AppointedTime)
            .ToListAsync();
    }

    private Color GetStatusColor(OrderStatus status) => status switch
    {
        OrderStatus.Pending    => Color.Warning,
        OrderStatus.Accepted   => Color.Info,
        OrderStatus.Waiting    => Color.Primary,
        OrderStatus.Processing => Color.Secondary,
        OrderStatus.Complete   => Color.Success,
        OrderStatus.Declined   => Color.Error,
        _ => Color.Default
    };

    private string GetStatusRus(OrderStatus status) => status switch
    {
        OrderStatus.Pending    => "В процессе оформления",
        OrderStatus.Accepted   => "Принят",
        OrderStatus.Waiting    => "Ожидание назначенного времени",
        OrderStatus.Processing => "В процессе выполнения",
        OrderStatus.Complete   => "Завершён",
        OrderStatus.Declined   => "Отклонён",
        _ => "Неизвестно"
    };

    // Computed list
    private IEnumerable<Order> FilteredOrders =>
        SortOrders(
            OrderList
                .Where(o => _selectedStatus == null || o.Status == _selectedStatus)
                .ToList()
        );

    private IEnumerable<Order> SortOrders(IEnumerable<Order> list)
    {
        return _selectedSort switch
        {
            OrderSort.AppointedAsc => list.OrderBy(o => o.AppointedTime),
            OrderSort.AppointedDesc => list.OrderByDescending(o => o.AppointedTime),
            OrderSort.CreatedAsc => list.OrderBy(o => o.OrderTime),
            OrderSort.CreatedDesc => list.OrderByDescending(o => o.OrderTime),
            _ => list
        };
    }
}
