@using System.Security.Claims
@using barberchainAPI.Functional.Services
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IProfileService ProfileService
@inject INotificationService NotificationService
@inject BarberchainDbContext Context
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <MudContainer Style="margin-bottom: 12px; border-radius: 0.5rem; border: 1px solid black; width: 80%;">
        <MudStack Class="mt-4 mb-4" Row="true" AlignItems="AlignItems.Center">
            <MudText>Адрес: </MudText>
            <MudText style="width: fit-content;">@barber?.Bshop.Address</MudText>
        </MudStack>
        <MudStack Class="mb-4 mt-4" Row="true" AlignItems="AlignItems.Center">
            <MudText>Сотрудник: </MudText>
            <MudSelect Style="max-width: fit-content;" T="Barber" @bind-Value="@_selectedBarber" Text="@(_selectedBarber?.Account.Lastname + " " + _selectedBarber?.Account.Restname)">
                @if (barber != null)
                {
                    foreach (var b in barber.Bshop.Barbers)
                    {
                        <MudSelectItem T="Barber" Value="@b">@b.Account.Lastname @b.Account.Restname</MudSelectItem>
                    }
                }
            </MudSelect>
        </MudStack>
        <MudStack Class="mb-4" Row="true" AlignItems="AlignItems.Center">
            <MudText>Дата: </MudText>
            <MudDatePicker IsDateDisabledFunc="@((DateTime dt)=>(dt < DateTime.Today || dt > DateTime.Today.AddDays(7)) || dt.DayOfWeek == DayOfWeek.Saturday || dt.DayOfWeek == DayOfWeek.Sunday)" Style="width: fit-content;" @bind-Date="@_selectedDate"></MudDatePicker>
        </MudStack>
        <MudStack Class="mb-4" Row="true" AlignItems="AlignItems.Center">
            <MudText>Номер телефона: </MudText>
            <MudTextField Style="width: fit-content;" T="string" @bind-Value="@orderBeingCreated.Phone"></MudTextField>
        </MudStack>
        <MudButton Disabled="@(_selectedBarber == null || string.IsNullOrEmpty(orderBeingCreated.Phone))" Class="mb-4 ml-auto" @onclick="OpenBookDialogAsync" Variant="Variant.Filled" Color="Color.Primary">
            Забронировать
        </MudButton>
    </MudContainer>

    <OrdersToDeliver Method="OrderMethod.Phone" User="@User" OnlyPhoneBooked="true"></OrdersToDeliver>
</MudPaper>

@code
{
        /*
        * List phone-booked orders with Decline button in case the client would like to cancel his order
        * Time booking with all jobs of the selected barber (matter of providing correct params)
        */

    private Order orderBeingCreated = new Order();

    [Parameter]
    public int BarberId { get; set; }

    private Barber barber = default!;

    private Barber _selectedBarber = default!;

    [Parameter]
    public ClaimsPrincipal? User { get; set; }

    private DateTime? _selectedDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        barber = await Context.Barbers
            .Include(b => b.Bshop)
                .ThenInclude(bs => bs.Barbers)
                    .ThenInclude(b => b.Account)
            .Include(b => b.BarberJobs)
                .ThenInclude(bj => bj.Job)
            .Where(b => b.Id == BarberId)
            .FirstAsync();
    }

    private async Task OpenBookDialogAsync()
    {
        var atuPattern = await ProfileService.GetAvailabilityForDayAsync(_selectedBarber.Id, _selectedDate);
        var jobSet = Context.BarberJobs
            .Include(bj => bj.Job)
            .Where(bj => bj.BarberId == _selectedBarber.Id)
            .Select(bj => bj.Job);

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true };
        var params_ = new DialogParameters<BarberPageDialog> {
            { x => x.AtuPattern, atuPattern },
            { y => y.SelectedDate, _selectedDate},
            { z => z.BarberId, _selectedBarber.Id },
            { w => w.user, null },
            { u => u.JobSet, jobSet },
            { v => v.PhoneBooking, true },
            { p => p.Phone, orderBeingCreated.Phone } };

        var dialog = await DialogService.ShowAsync<BarberPageDialog>("Book time", params_, options);
        var dialogRes = await dialog.Result;
        if (dialogRes != null && !dialogRes.Canceled)
        {
            orderBeingCreated = (dialogRes.Data as Order)!;

            await NotificationService.NotifyAsync(_selectedBarber.AccountId!.Value,
                $"У вас новый заказ #{orderBeingCreated.Id} на {orderBeingCreated.AppointedTime}\nУслуги: " + string.Join(", ", Context.OrderJobs.Where(oj => oj.OrderId == orderBeingCreated.Id).Select(oj => oj.Job.Name)),
                NotificationType.General);

            Snackbar.Add($"Успешно добавлен новый заказ по телефону", Severity.Success);
        }
    }
}
