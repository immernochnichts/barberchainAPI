@namespace barberchainAPI.Components.Pages
@page "/barbershop/{Id:int}"
@rendermode InteractiveServer
@using barberchainAPI.Functional
@inject NavigationManager Navigation
@inject BarberchainDbContext Context
@inject CartService CartService

@using barberchainAPI.Data  <!-- Namespace with Barbershop model -->
@using MudBlazor

@if (Barbershop is null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer Style="max-width:800px;" Class="mx-auto mt-4">
        <MudPaper Class="pa-4">

            @if (Barbershop == null)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <!-- Map placeholder -->
                        <MudPaper Class="pa-2" Style="height:200px; display:flex; align-items:center; justify-content:center; background:#eee;">
                            Map placeholder
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.h4">@Barbershop.Address</MudText>
                        <MudText Typo="Typo.subtitle1">📞 @Barbershop.Phone</MudText>
                        <MudText Typo="Typo.subtitle2">
                            🕒 @(oh < 10 ? "0" + oh : oh):@(om < 10 ? "0" + om : om) - @(ch < 10 ? "0" + ch : ch):@(cm < 10 ? "0" + cm : cm)
                        </MudText>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h5" Class="mb-2 d-flex">Услуги</MudText>
                <MudList T="string" Class="d-flex flex-wrap">
                    @foreach (var job in Service)
                    {
                        <MudContainer Class="d-flex mb-4" Style="align-items:center;">
                            <MudListItem Text=@job.Name />
                            @if (cart != null)
                            {
                                <MudButton @onclick="async () => { await OnServiceClicked(job); }" Style=@($"background:{(cart.JobSet.Contains(job) ? "gray" : job.ColorCSS)}; height:min-content;")>@(cart.JobSet.Contains(job) ? "Добавлено" : "")</MudButton>
                            }
                        </MudContainer>
                    }
                </MudList>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h5" Class="mb-2">Barbers</MudText>
                <MudGrid>
                    @foreach (var barber in Barbershop.Barbers)
                    {
                        @if (cart != null && barber.BarberJobs.Select(bj => bj.Job).ToHashSet().IsSupersetOf(cart.JobSet))
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudCard>
                                    <MudCardContent>
                                        <MudText Typo="Typo.subtitle1">@barber.Account.Lastname @barber.Account.Restname</MudText>
                                        <a href=@($"/account/{barber.AccountId}")>
                                            <MudImage Src="@AccountPage.GetImageSrc(barber.Account.ProfilePic)" Alt="Barber profile pic" Class="rounded" ObjectFit="ObjectFit.Cover" Style="width:100%;height:auto;" />
                                        </a>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        }
                    }
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h5" Class="mb-2">Gallery</MudText>
                <MudGrid>
                    @foreach (var image in Barbershop.Images)
                    {
                        <MudItem xs="6" sm="4" md="3">
                            <MudPaper Elevation="1" Class="pa-1">
                                <MudImage Src="@AccountPage.GetImageSrc(image.ImgFile)" Alt="Auxiliary image" Style="width:100%;height:auto;" />
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
        </MudPaper>
    </MudContainer>
}
@code {
    [Parameter] public int Id { get; set; }
    private Barbershop? Barbershop { get; set; }

    private List<Job>? Service { get; set; } = new List<Job>();

    private int oh, om, ch, cm;

    protected override async Task OnInitializedAsync()
    {

        try
        { 
            Barbershop = await Context.Barbershops
             .Include(bs => bs.Barbers)
                 .ThenInclude(b => b.Account)
             .Include(bs => bs.Barbers)
                 .ThenInclude(b => b.BarberJobs)
                     .ThenInclude(bj => bj.Job)
             .Include(bs => bs.Images)
             .Where(bs => bs.Id == Id)
             .FirstOrDefaultAsync();

            if (Barbershop is null)
            {
                Navigation.NavigateTo("/");
            }

            int openingBit = -1;
            for (int i = 0; i < 96; i++)
            {
                if (Barbershop.DefaultSchedule[i]) // BitArray or bool[]
                {
                    openingBit = i;
                    break;
                }
            }

            if (openingBit == -1)
            {
                // No schedule available
                oh = 0;
                om = 0;
            }
            else
            {
                oh = openingBit / 4;          // hour
                om = (openingBit % 4) * 15;   // minute
            }

            int closingBit = -1;
            for (int i = 95; i >= 0; i--)
            {
                if (Barbershop.DefaultSchedule[i])
                {
                    closingBit = i;
                    break;
                }
            }

            if (closingBit == -1)
            {
                // No schedule available
                ch = 0;
                cm = 0;
            }
            else
            {
                // Closing time is the END of last available interval
                ch = (closingBit + 1) / 4;
                cm = ((closingBit + 1) % 4) * 15;
            }


            var jobIdSet = new HashSet<int>();
            foreach (var b in Barbershop.Barbers)
            {
                jobIdSet = await Context.BarberJobs.Where(bj => b.Id == bj.BarberId).Select(bj => bj.JobId).ToHashSetAsync();

                foreach (var id in jobIdSet)
                {
                    Service.Add(await Context.Jobs.Where(j => j.Id == id).FirstOrDefaultAsync());
                }
            }
        }
        catch(Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    private Cart? cart;

    protected override async Task OnAfterRenderAsync(bool firstTime)
    {
        if (firstTime)
        {
            cart = await CartService.GetCart();
            StateHasChanged();
        }
    }

    private async Task OnServiceClicked(Job j)
    {
        if (cart.JobSet.Contains(j))
        {
            await CartService.RemoveItem(j.Id);
        }
        else
        {
            await CartService.AddToCart(j);
        }

        cart = await CartService.GetCart(); // update the cart

        StateHasChanged();
    }
}
