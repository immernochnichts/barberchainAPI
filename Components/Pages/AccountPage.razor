@page "/account/{id:int}"
@rendermode InteractiveServer
@using System.IO
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using System.Collections;
@using System.Security.Claims
@inject BarberchainDbContext Context
@inject IDialogService DialogService;
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
<MudDialogProvider />

@if (account == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer Style="max-width:800px;" Class="mx-auto mt-4">

        <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
            <MudButton @onclick="() => currentComponent = AccountComponent.Profile">Профиль</MudButton>
            <MudButton @onclick="() => currentComponent = AccountComponent.Reviews">Мои отзывы</MudButton>
            <MudButton @onclick="() => currentComponent = AccountComponent.Notifications">Уведомления</MudButton>
            <MudButton @onclick="() => currentComponent = AccountComponent.OrderHistory">История заказов</MudButton>
        </MudButtonGroup>

        @switch (currentComponent)
        {
            case AccountComponent.Profile:
            {
                <Profile></Profile>
                break;
            }
            case AccountComponent.Reviews:
            {
                <Reviews></Reviews>
                break;
            }
            case AccountComponent.Notifications:
            {
                <Notifications></Notifications>
                break;
            }
            case AccountComponent.OrderHistory:
            {
                <OrderHistroy></OrderHistroy>
                break;
            }
        }

    </MudContainer>
}

@code
{
    private enum AccountComponent
    {
        Profile,
        Reviews,
        Notifications,
        OrderHistory
    }

    private AccountComponent currentComponent = AccountComponent.Notifications;

    [Parameter] public int id { get; set; }
    protected bool IsOwner = false;

    protected ClaimsPrincipal? user;

    protected Account? account;

    //Barber variables
    protected List<BarberJob> jobs;
    protected Barber? barber;
    public BitArray? AtuPattern { get; set; }

    protected DateTime? _selectedDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        account = await Context.Accounts
            .FirstOrDefaultAsync(a => a.Id == id);

        if (account is null)
        {
            Navigation.NavigateTo("/");
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        this.user = authState.User;

        Console.WriteLine("=== CLAIMS ===");
        foreach (var c in user.Claims)
            Console.WriteLine($"{c.Type} = {c.Value}");

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                IsOwner = userId == id;
            }
        }

        if (account.Role == AccountRole.Barber)
        {
            // Load the barber and related data (account, images, etc.)
            barber = await Context.Barbers
                .Include(b => b.Account)
                .Include(b => b.Images)
                .FirstOrDefaultAsync(b => b.AccountId == id);

            jobs = Context.BarberJobs
                .Include(x => x.Job)
                .Where(x => x.BarberId == id)
                .ToList();

            AtuPattern = await GetAvailabilityForDay(id, _selectedDate);
        }
    }

    public static string GetImageSrc(byte[]? imageBytes)
    {
        if (imageBytes == null || imageBytes.Length == 0)
            return "images/default-profile.jpg"; // fallback

        string base64 = Convert.ToBase64String(imageBytes);
        return $"data:image/jpeg;base64,{base64}";
    }

    public async Task<BitArray> GetAvailabilityForDay(int barberId, DateTime? day)
    {

        var availability = await Context.BarberScheduleDays
            .Where(a => a.BarberId == barberId && a.Date == day.Value.ToUniversalTime())
            .Select(a => a.AtuPattern)
            .FirstOrDefaultAsync();

        if (availability is null)
        {
            availability = new BitArray(Enumerable.Repeat<bool>(false, 96).ToArray());
        }

        return availability;
    }

    protected Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true };
        var params_ = new DialogParameters<BarberPageDialog> { { x => x.AtuPattern, AtuPattern } };

        return DialogService.ShowAsync<BarberPageDialog>("Book time", params_, options);
    }
}
