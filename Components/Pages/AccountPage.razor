@namespace barberchainAPI.Components.Pages
@page "/account/{id:int}"
@rendermode InteractiveServer
@using System.IO
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using System.Collections
@using System.Security.Claims
@using barberchainAPI.Functional
@inject CartService CartService
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (account is null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer  Style="max-width:850px;" Class="mx-auto pa-0 mt-4">
        @if (IsOwner)
        {
            <MudButton Color="Color.Error" @onclick="Logout">Выйти из аккаунта</MudButton>

            <MudFlexBreak></MudFlexBreak>

            <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                <MudButton @onclick="() => Goto(AccountComponent.Profile)">Профиль</MudButton>
                <MudButton @onclick="() => Goto(AccountComponent.Reviews)">Мои отзывы</MudButton>
                <MudButton @onclick="() => Goto(AccountComponent.Notifications)">Уведомления</MudButton>
                <MudButton @onclick="() => Goto(AccountComponent.OrderHistory)">История заказов</MudButton>
                <MudButton @onclick="() => Goto(AccountComponent.Cart)">Корзина</MudButton>
            </MudButtonGroup>

            if (account.Role == AccountRole.Barber)
            {
                <MudButtonGroup Style="background: #276FBF;" Variant="Variant.Filled">
                    <MudButton Style="color:white;" Disabled="barber!.BshopId == null" @onclick="OpenAdjustmentDialog">Изменить расписание</MudButton>
                    <MudButton Style="color:white;" @onclick="() => Goto(AccountComponent.OrdersToDeliver)">Заказы мне</MudButton>
                    <MudButton Style="color:white;" @onclick="() => Goto(AccountComponent.PhoneOrderPlacement)">Оформить телефонный заказ</MudButton>
                    <MudButton Style="color:white;" Disabled="barber.BshopId == null" @onclick="OpenComplaintCreationDialog">Пожаловаться</MudButton>
                </MudButtonGroup>
            }

            if (account.Role == AccountRole.Manager || account.Role == AccountRole.Admin)
            {
                <MudButtonGroup Style="background: #DF1674;" Variant="Variant.Filled">
                    <MudButton Style="color:white;" @onclick="() => Goto(AccountComponent.UserList)">Список пользователей</MudButton>
                    <MudButton Style="color:white;" @onclick="() => Goto(AccountComponent.ScheduleRequests)">Заявки на изменение расписания</MudButton>
                    <MudButton Style="color:white;" @onclick="() => Goto(AccountComponent.ReportedReviews)">Отзывы с жалобами</MudButton>
                </MudButtonGroup>
            }

            if (account.Role == AccountRole.Admin)
            {
                <MudFlexBreak></MudFlexBreak>

                <MudButtonGroup Style="background: #54B6B2;" Variant="Variant.Filled">
                    <MudButton Style="color:white;" @onclick="() => Goto(AccountComponent.Complaints)">Жалобы</MudButton>
                </MudButtonGroup>
            }
        }
    </MudContainer>

    <MudContainer  Style="max-width:850px; border: 1px solid black;" Class="mx-auto pa-0">
        
        @switch (CurrentComponent)
        {
            case AccountComponent.Profile:
            {
                <Profile id="@id" user="@user" account="@account" barber="@barber" jobs="@jobs"></Profile>
                break;
            }
            case AccountComponent.Reviews:
            {
                <Reviews id="@id"></Reviews>
                break;
            }
            case AccountComponent.Notifications:
            {
                <Notifications id="@id"></Notifications>
                break;
            }
            case AccountComponent.OrderHistory:
            {
                <OrderHistroy id="@id"></OrderHistroy>
                break;
            }
            case AccountComponent.Cart:
            {
                <CartPage></CartPage>
                break;
            }
            case AccountComponent.UserList:
            {
                <UserList UserId="@(int.Parse(user.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value))"></UserList>
                break;
            }
            case AccountComponent.ScheduleRequests:
            {
                <ScheduleRequests User="@user"></ScheduleRequests>
                break;
            }
            case AccountComponent.OrdersToDeliver:
            {
                <OrdersToDeliver User="@user"></OrdersToDeliver>
                break;
            }
            case AccountComponent.Complaints:
            {
                <Complaints></Complaints>
                break;
            }
            case AccountComponent.ReportedReviews:
            {
                <ReportedReviewsList></ReportedReviewsList>
                break;
            }
            case AccountComponent.PhoneOrderPlacement:
            {
                <PhoneOrderPlacement Barber="@barber" User="@user"></PhoneOrderPlacement>
                break;
            }
        }

    </MudContainer>
}

@code
{
    public enum AccountComponent
    {
        Profile,
        Reviews,
        Notifications,
        OrderHistory,
        Cart,
        UserList,
        ScheduleRequests,
        OrdersToDeliver,
        Complaints,
        ReportedReviews,
        PhoneOrderPlacement
    }

    [Inject]
    protected BarberchainDbContext Context { get; set; } = default!;

    [Inject]
    NavigationManager Navigation { get; set; } = default!;

    [Inject]
    AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    public AccountComponent CurrentComponent { get; set; } = AccountComponent.Profile;

    [Parameter]
    [SupplyParameterFromQuery(Name = "component")]
    public string ComponentQuery { get; set; } = default!;

    [Parameter] public int id { get; set; }
    protected bool IsOwner = false;

    protected ClaimsPrincipal? user;

    protected Account? account;

    //Barber variables
    private List<BarberJob> jobs;
    private Barber? barber;
    private BitArray? AtuPattern;

    protected override async Task OnInitializedAsync()
    {
        account = await Context.Accounts.FirstOrDefaultAsync(a => a.Id == id);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        this.user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                IsOwner = userId == id;
            }
        }

        if (account is not null && account.Role == AccountRole.Barber)
        {
            barber = await Context.Barbers
                .Include(b => b.BarberJobs)
                    .ThenInclude(bj => bj.Job)
                .Include(b => b.Account)
                .Include(b => b.Images)
                .Include(b => b.Bshop)
                    .ThenInclude(b => b.Manager)
                .Include(b => b.Bshop)
                    .ThenInclude(bs => bs.Barbers)
                        .ThenInclude(b => b.Account)
                .FirstOrDefaultAsync(b => b.AccountId == id);

            jobs = await Context.BarberJobs
                .Include(x => x.Job)
                .Where(x => x.BarberId == barber!.Id)
                .ToListAsync();
        }
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(ComponentQuery)
            && Enum.TryParse<AccountComponent>(ComponentQuery, true, out var comp))
        {
            if (user == null)
            {
                CurrentComponent = AccountComponent.Profile;
                return;
            }

            int signedInUserId = int.Parse(user.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);

            if (id != signedInUserId)
            {
                CurrentComponent = AccountComponent.Profile;
                return;
            }

            CurrentComponent = comp;
        }
        else
        {
            CurrentComponent = AccountComponent.Profile;
        }
    }

    public static string GetImageSrc(byte[]? imageBytes)
    {
        if (imageBytes == null || imageBytes.Length == 0)
            return "images/default-profile.jpg"; // fallback

        string base64 = Convert.ToBase64String(imageBytes);
        return $"data:image/jpeg;base64,{base64}";
    }

    private async Task Logout()
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Подтвердите выход",
            $"Выйти из аккаунта?",
            yesText: "Выйти", cancelText: "Отмена");

        if (confirmed == true)
        {
            var result = await JS.InvokeAsync<bool>("auth.logout");

            if (result)
            {
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Snackbar.Add("Не удалось выйти из аккаунта", Severity.Error);
            }
        }
    }

    private async Task OpenAdjustmentDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraLarge, FullWidth = true };
        var parameters = new DialogParameters<CreateScheduleDialog>
        {
            { x => x.Barber, barber }
        };

        await DialogService.ShowAsync<CreateScheduleDialog>("Request Schedule Adjustment", parameters, options);
    }

    private async Task OpenComplaintCreationDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraLarge, FullWidth = true };
        var parameters = new DialogParameters<SendComplaintDialog>
        {
            { x => x.Sender, barber }
        };

        await DialogService.ShowAsync<SendComplaintDialog>("Complaint creation", parameters, options);
    }

    private void Goto(AccountComponent component)
    {
        Navigation.NavigateTo($"account/{id}?component={component.ToString()}");
        Navigation.Refresh();
    }
}