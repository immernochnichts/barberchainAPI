@page "/account/{id:int}"
@using System.IO
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using System.Collections;
@inject BarberchainDbContext Context
@inject IDialogService DialogService;
@inject AuthenticationStateProvider AuthStateProvider
<MudDialogProvider />

@if (account == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer Style="max-width:800px;" Class="mx-auto mt-4">

        @if (IsOwner)
        {
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
            <MudButton>Профиль</MudButton>
            <MudButton>Мои отзывы</MudButton>
            <MudButton>Уведомления</MudButton>
            <MudButton>История заказов</MudButton>
            </MudButtonGroup>
        }

        <MudPaper Elevation="3" Class="p-4 rounded-lg">
            <!-- Profile Section -->
            <MudContainer Style="display:flex; padding-top:1rem;">
                <MudImage Src="@GetImageSrc(account.ProfilePic)" Class="rounded-lg" Elevation="25" ObjectFit="ObjectFit.Cover" Style="max-width:50%;" />
                <MudContainer Style="display:flex; flex-direction:column; align-items:flex-start;">
                    <MudText Typo="Typo.h5" Align="Align.Center">@account.Lastname @account.Restname</MudText>
                    <MudText Typo="Typo.h6" Align="Align.Center">обо мне:</MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Class="text-secondary">
                        @account.Bio
                    </MudText>
                </MudContainer>
            </MudContainer>
        </MudPaper>
    </MudContainer>
}

@code
{
    [Parameter]
    public int id { get; set; }
    private bool IsOwner = false;

    private Account? account;

    private DateTime? _selectedDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        account = await Context.Accounts
            .FirstOrDefaultAsync(a => a.Id == id);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                IsOwner = userId == id;
            }
        }
    }

    public static string GetImageSrc(byte[]? imageBytes)
    {
        if (imageBytes == null || imageBytes.Length == 0)
            return "images/default-profile.jpg"; // fallback

        string base64 = Convert.ToBase64String(imageBytes);
        return $"data:image/jpeg;base64,{base64}";
    }
}
