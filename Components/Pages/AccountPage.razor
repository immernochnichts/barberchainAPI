@page "/account/{id:int}"
@rendermode InteractiveServer
@using System.IO
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using System.Collections;
@using System.Security.Claims
<MudDialogProvider />

@if (account is null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer Style="max-width:800px;" Class="mx-auto mt-4">

        @if (IsOwner)
        {
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                <MudButton @onclick="() => currentComponent = AccountComponent.Profile">Профиль</MudButton>
                <MudButton @onclick="() => currentComponent = AccountComponent.Reviews">Мои отзывы</MudButton>
                <MudButton @onclick="() => currentComponent = AccountComponent.Notifications">Уведомления</MudButton>
                <MudButton @onclick="() => currentComponent = AccountComponent.OrderHistory">История заказов</MudButton>
            </MudButtonGroup>
        }
        
        @switch (currentComponent)
        {
            case AccountComponent.Profile:
            {
                <Profile id="@id" user="@user" account="@account"></Profile>
                break;
            }
            case AccountComponent.Reviews:
            {
                <Reviews id="@id"></Reviews>
                break;
            }
            case AccountComponent.Notifications:
            {
                <Notifications id="@id"></Notifications>
                break;
            }
            case AccountComponent.OrderHistory:
            {
                <OrderHistroy id="@id"></OrderHistroy>
                break;
            }
        }

    </MudContainer>
}

@code
{
    private enum AccountComponent
    {
        Profile,
        Reviews,
        Notifications,
        OrderHistory
    }

    [Inject]
    protected BarberchainDbContext Context { get; set; }

    [Inject]
    NavigationManager Navigation { get; set; }

    [Inject]
    AuthenticationStateProvider AuthStateProvider { get; set; }

    private AccountComponent currentComponent = AccountComponent.Profile;

    [Parameter] public int id { get; set; }
    protected bool IsOwner = false;

    protected ClaimsPrincipal? user;

    protected Account? account;

    protected override async Task OnInitializedAsync()
    {
        account = await Context.Accounts.FirstOrDefaultAsync(a => a.Id == id);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        this.user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            Console.WriteLine("=== CLAIMS ===");
            foreach (var c in user.Claims)
                Console.WriteLine($"{c.Type} = {c.Value}");

            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                IsOwner = userId == id;
            }
        }
    }

    public static string GetImageSrc(byte[]? imageBytes)
    {
        if (imageBytes == null || imageBytes.Length == 0)
            return "images/default-profile.jpg"; // fallback

        string base64 = Convert.ToBase64String(imageBytes);
        return $"data:image/jpeg;base64,{base64}";
    }
}