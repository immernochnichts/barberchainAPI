@page "/account/{id:int}"
@rendermode InteractiveServer
@using System.IO
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using System.Collections
@using System.Security.Claims
@using barberchainAPI.Functional
@inject CartService CartService
<MudDialogProvider />

@if (account is null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer Style="max-width:800px;" Class="mx-auto mt-4">

        @if (IsOwner)
        {
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                <MudButton @onclick="() => CurrentComponent = AccountComponent.Profile">Профиль</MudButton>
                <MudButton @onclick="() => CurrentComponent = AccountComponent.Reviews">Мои отзывы</MudButton>
                <MudButton @onclick="() => CurrentComponent = AccountComponent.Notifications">Уведомления</MudButton>
                <MudButton @onclick="() => CurrentComponent = AccountComponent.OrderHistory">История заказов</MudButton>
                <MudButton @onclick="() => CurrentComponent = AccountComponent.Cart">Корзина</MudButton>
            </MudButtonGroup>
        }
        
        @switch (CurrentComponent)
        {
            case AccountComponent.Profile:
            {
                <Profile id="@id" user="@user" account="@account" barber="@barber" jobs="@jobs"></Profile>
                break;
            }
            case AccountComponent.Reviews:
            {
                <Reviews id="@id"></Reviews>
                break;
            }
            case AccountComponent.Notifications:
            {
                <Notifications id="@id"></Notifications>
                break;
            }
            case AccountComponent.OrderHistory:
            {
                <OrderHistroy id="@id"></OrderHistroy>
                break;
            }
            case AccountComponent.Cart:
            {
                <CartPage></CartPage>
                break;
            }
        }

    </MudContainer>
}

@code
{
    public enum AccountComponent
    {
        Profile,
        Reviews,
        Notifications,
        OrderHistory,
        Cart
    }

    [Inject]
    protected BarberchainDbContext Context { get; set; }

    [Inject]
    NavigationManager Navigation { get; set; }

    [Inject]
    AuthenticationStateProvider AuthStateProvider { get; set; }

    [Parameter]
    public AccountComponent CurrentComponent { get; set; } = AccountComponent.Profile;

    [Parameter] public int id { get; set; }
    protected bool IsOwner = false;

    protected ClaimsPrincipal? user;

    protected Account? account;

    //Barber variables
    private List<BarberJob> jobs;
    private Barber? barber;
    private BitArray? AtuPattern;

    protected override async Task OnInitializedAsync()
    {
        account = await Context.Accounts.FirstOrDefaultAsync(a => a.Id == id);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        this.user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            Console.WriteLine("=== CLAIMS ===");
            foreach (var c in user.Claims)
                Console.WriteLine($"{c.Type} = {c.Value}");

            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                IsOwner = userId == id;
            }
        }

        if (account is not null && account.Role == AccountRole.Barber)
        {
            barber = await Context.Barbers
                .Include(b => b.Account)
                .Include(b => b.Images)
                .FirstOrDefaultAsync(b => b.AccountId == id);

            jobs = await Context.BarberJobs
                .Include(x => x.Job)
                .Where(x => x.BarberId == barber.Id)
                .ToListAsync();
        }
    }

    public static string GetImageSrc(byte[]? imageBytes)
    {
        if (imageBytes == null || imageBytes.Length == 0)
            return "images/default-profile.jpg"; // fallback

        string base64 = Convert.ToBase64String(imageBytes);
        return $"data:image/jpeg;base64,{base64}";
    }
}