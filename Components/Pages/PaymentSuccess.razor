@namespace barberchainAPI.Components.Pages
@using MudBlazor
@using barberchainAPI.Functional.Services
@inject NavigationManager Navigation
@inject BarberchainDbContext Context
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IOrderService OrderService
@inject INotificationService NotificationService

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6 text-center">

    <MudPaper Elevation="4" Class="pa-6">

        <!-- Success Icon -->
        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" Class="mb-4" />

        @if (order != null)
        {
            <MudText Typo="Typo.h4" Class="mb-2">@(order.IsPaid ? "Заказ оформлен и оплачен" : "Заказ оформлен")</MudText>
            <MudText Typo="Typo.subtitle1" Class="mb-4">Ваш заказ <b>#@order.Id</b> был успешно обработан.</MudText>

            <MudStack Spacing="1" AlignItems="AlignItems.Start" Class="mb-4">
                <MudText>
                    Стоимость заказа: <b>@(
                        order.Barber.BarberJobs
                        .Where(bj => order.OrderJobs.Select(oj => oj.JobId).Contains(bj.JobId)) // only jobs in this order
                        .Sum(bj => bj.Price ?? bj.Job.DefaultPrice))
                    </b>
                </MudText>
                <MudText>Способ оплаты: <b>@(order.IsPaid ? "Банковская карта" : "На месте")</b></MudText>
                <MudText>Назначенное время: <b>@order.AppointedTime</b></MudText>
            </MudStack>

            <!-- Buttons -->
            <MudStack Row="true" Spacing="2">
                @if (Account != null)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoToOrders">
                        Мои заказы
                    </MudButton>
                }
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="GoHome">
                    На главную
                </MudButton>
                @if (order != null && order.Status == OrderStatus.Waiting)
                {
                    <MudButton Color="Color.Error" Class="ml-auto" @onclick="CancelOrder">
                        Отменить заказ
                    </MudButton>
                }
            </MudStack>
        }

    </MudPaper>

</MudContainer>

@code {
    [Parameter]
    public Account Account { get; set; } = default!;

    [Parameter]
    public Order? order { get; set; }

    private void GoToOrders()
    {
        Navigation.NavigateTo($"/account/{Account.Id}?component=OrderHistory");
        Navigation.Refresh();
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
        Navigation.Refresh();
    }

    private async Task CancelOrder()
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Подтвердите отмену",
            $"Отменить заказ?",
            yesText: "Подтвердить", cancelText: "Назад");

        if (confirmed == true)
        {
            order!.Status = OrderStatus.Declined;

            var bsd = await Context.BarberScheduleDays.Where(d => d.Date == DateOnly.FromDateTime(order.AppointedTime) && d.BarberId == order.BarberId).FirstAsync();

            await OrderService.EraseOrderFromScheduleAsync(bsd, order);

            if (bsd.Barber.AccountId != null)
            {
                await NotificationService.NotifyAsync(bsd.Barber.AccountId.Value, $"Заказ #{order.Id} был отменён", NotificationType.General);
            }

            Snackbar.Add("Заказ успешно отменён", Severity.Success);
        }
    }
}