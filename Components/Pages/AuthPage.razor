@page "/auth"
@rendermode InteractiveServer
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<MudGrid Style="width: 40%" Class="mx-auto">
    @if (!regPressed)
    {
        <MudItem Class="mx-auto" xs="12" sm="7">
            <MudPaper Class="pa-4">
                <MudForm @ref="form" @bind-IsValid="success" @bind-Errors="errors">
                    <MudTextField T="string" Label="Email" @bind-Value="loginEmail"
                                  Required="true" RequiredError="Адрес эл. почты обязателен"
                                  Validation="@(new EmailAddressAttribute { ErrorMessage = "Недопустимый адрес эл. почты" })" />
                    <MudTextField T="string" Label="Password" @bind-Value="loginPassword"
                                  InputType="InputType.Password"
                                  Required="true" RequiredError="Пароль обязателен" />
                    <div class="d-flex align-center justify-space-between">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!success)" Class="mr-auto mt-4" @onclick="LoginAsync">Войти</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mr-auto mt-4" @onclick="Toggle">Зарегистрироваться</MudButton>
                    </div>
                </MudForm>
            </MudPaper>
        </MudItem>
    }
    else
    {
        <MudItem Class="mx-auto" xs="12" sm="7">
            <MudPaper Class="pa-4">
                <MudForm @ref="form" @bind-IsValid="success" @bind-Errors="errors">
                    <MudTextField T="string" Label="Фамилия (псевдоним)" @bind-Value="regLastname"
                                  Required="true" RequiredError="Поле обязательно для ввода" />
                    <MudTextField T="string" Label="Имя Отчество" @bind-Value="regRestname" />
                    <MudTextField T="string" Label="Email" @bind-Value="regEmail"
                                  Required="true" RequiredError="Адрес эл. почты обязателен"
                                  Validation="@(new EmailAddressAttribute { ErrorMessage = "Недопустимый адрес эл. почты" })" />
                    <MudTextField T="string" Label="Password" @bind-Value="regPassword"
                                  InputType="InputType.Password"
                                  Required="true" RequiredError="Пароль обязателен"
                                  Validation="@(PasswordStrength)" />
                    <MudTextField T="string" Label="Повторите пароль" @bind-Value="regPasswordConfirm"
                                  InputType="InputType.Password"
                                  Validation="@(PasswordMatch)" />
                    <div class="d-flex align-center justify-space-between">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!success)" Class="mr-auto mt-4" @onclick="RegisterAsync">Зарегистрироваться</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mr-auto mt-4" @onclick="Toggle">Войти</MudButton>
                    </div>
                </MudForm>
            </MudPaper>
        </MudItem>
    }
</MudGrid>

@code {
    // Form state
    bool success;
    string[] errors = { };
    MudForm form;
    bool regPressed = false;

    // Login fields
    string loginEmail;
    string loginPassword;

    // Registration fields
    string regLastname;
    string regRestname;
    string regEmail;
    string regPassword;
    string regPasswordConfirm;

    private void Toggle()
    {
        regPressed = !regPressed;
        ClearForm();
        form.ResetValidation();
    }

    private void ClearForm()
    {
        loginEmail = loginPassword = string.Empty;
        regLastname = regRestname = regEmail = regPassword = regPasswordConfirm = string.Empty;
    }

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Требуется пароль";
            yield break;
        }
        if (pw.Length < 8)
            yield return "Пароль должен состоять из по крайней мере 8-ми символов";
        if (!Regex.IsMatch(pw, @"[0-9]"))
            yield return "Пароль должен содержать хотя бы одну цифру";
    }

    private string PasswordMatch(string pwConfirm)
    {
        if (regPassword != pwConfirm)
            return "Пароли не совпадают";
        return null;
    }

    private async Task RegisterAsync()
    {
        await form.Validate();
        if (!success) return;

        var client = HttpClientFactory.CreateClient("server");
        var content = new FormUrlEncodedContent(new Dictionary<string, string>
        {
            { "Lastname", regLastname },
            { "Restname", regRestname ?? "" },
            { "Email", regEmail },
            { "Password", regPassword }
        });

        var response = await client.PostAsync("api/auth/register", content);

        if (!response.IsSuccessStatusCode)
        {
            var text = await response.Content.ReadAsStringAsync();
            errors = new[] { text.Contains("Email") ? "Email уже зарегистрирован" : "Ошибка регистрации" };
            return;
        }

        // Registration successful → automatically log in
        var loginContent = new FormUrlEncodedContent(new Dictionary<string, string>
        {
            { "email", regEmail },
            { "password", regPassword }
        });

        var loginResponse = await client.PostAsync("api/auth/login", loginContent);

        if (!loginResponse.IsSuccessStatusCode)
        {
            // Fallback: if login fails, show message but keep user on login form
            errors = new[] { "Регистрация успешна, но автоматический вход не удался. Войдите вручную." };
            Toggle(); // switch to login form
            return;
        }

        // Clear form and navigate to home
        ClearForm();
        regPressed = false;
        form.ResetValidation();
        StateHasChanged();
        Navigation.NavigateTo("/", true);
    }

    private async Task LoginAsync()
    {
        await form.Validate();
        if (!success) return;

        var client = HttpClientFactory.CreateClient("server");
        var content = new FormUrlEncodedContent(new Dictionary<string, string>
        {
            { "email", loginEmail },
            { "password", loginPassword }
        });

        var response = await client.PostAsync("api/auth/login", content);

        if (!response.IsSuccessStatusCode)
        {
            errors = new[] { "Неверный адрес эл. почты или пароль" };
            return;
        }

        Navigation.NavigateTo("/", true);
    }
}
