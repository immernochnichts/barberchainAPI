@namespace barberchainAPI.Components.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims;
@using MudBlazor
@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject BarberchainDbContext Context
    

<MudLayout>
    <NavMenu NotificationCount="@notificationCount"></NavMenu>
    <MudMainContent Style=
"background-color: white;
background-image: linear-gradient(
    to right,
    rgba(0, 0, 0, 0.1) 2px,
    rgba(255, 255, 255, 1) 2px
);
background-size: 20px 100%;
">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    protected ClaimsPrincipal? User { get; set; }

    private int notificationCount;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        User = authState.User;

        if (User != null && User.Identity!.IsAuthenticated)
        {
            var userId = int.Parse(User.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);
            notificationCount = Context.AccountNotifications.Where(an => an.AccountId == userId && !an.IsViewed).Count();
        }
    }

    protected void AccessProfile()
    {
        if (User is null)
        {
            return;
        }

        if (User.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                Navigation.NavigateTo($"/account/{userId}?component=Profile");
                Navigation.Refresh();
            }
        }
        else
        {
            Navigation.NavigateTo($"/auth");
            Navigation.Refresh();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity?.IsAuthenticated ?? true)
            return;

        var id = int.Parse(user.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);

        var account = await Context.Accounts.FindAsync(id);

        if (account?.IsBanned == true)
        {
            if (!Navigation.Uri.EndsWith("/banned"))
            {
                Navigation.NavigateTo("/banned", forceLoad: true);
            }
        }
    }
}